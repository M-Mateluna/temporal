CREATE OR REPLACE FUNCTION ejercicioajax.fn_persona_iu(
  _idpersona   INT,
  _nombre      TEXT,
  _apellidos   TEXT,
  _idregion    INT,
  _idcomuna    INT,
  _idprofesion INT
)
RETURNS TABLE(success BOOLEAN, message VARCHAR)
LANGUAGE plpgsql
AS $$
BEGIN
  -- VALIDACIONES BÁSICAS
  IF _nombre IS NULL OR BTRIM(_nombre) = '' THEN
    RETURN QUERY SELECT FALSE::BOOLEAN, 'EL NOMBRE ES OBLIGATORIO'::VARCHAR; RETURN;
  END IF;

  IF _apellidos IS NULL OR BTRIM(_apellidos) = '' THEN
    RETURN QUERY SELECT FALSE::BOOLEAN, 'LOS APELLIDOS SON OBLIGATORIOS'::VARCHAR; RETURN;
  END IF;

  -- EXISTE PROFESIÓN (mismo esquema)
  IF NOT EXISTS (SELECT 1 FROM ejercicioajax.profesion WHERE idprofesion = _idprofesion) THEN
    RETURN QUERY SELECT FALSE::BOOLEAN, 'IDPROFESION INEXISTENTE'::VARCHAR; RETURN;
  END IF;

  -- COMUNA PERTENECE A LA REGIÓN
  IF NOT EXISTS (
    SELECT 1 FROM ejercicioajax.comuna
     WHERE idcomuna = _idcomuna AND idregion = _idregion
  ) THEN
    RETURN QUERY SELECT FALSE::BOOLEAN, 'LA COMUNA NO PERTENECE A LA REGION'::VARCHAR; RETURN;
  END IF;

  -- UNICIDAD NOMBRE+APELLIDOS (excluye al propio en UPDATE)
  IF EXISTS (
    SELECT 1
      FROM ejercicioajax.persona
     WHERE LOWER(BTRIM(nombre))    = LOWER(BTRIM(_nombre))
       AND LOWER(BTRIM(apellidos)) = LOWER(BTRIM(_apellidos))
       AND (_idpersona = 0 OR idpersona <> _idpersona)
  ) THEN
    RETURN QUERY SELECT FALSE::BOOLEAN, 'YA EXISTE UNA PERSONA CON EL MISMO NOMBRE Y APELLIDOS'::VARCHAR; RETURN;
  END IF;

  -- INSERT / UPDATE
  IF _idpersona = 0 THEN
    INSERT INTO ejercicioajax.persona (nombre, apellidos, idregion, idcomuna, idprofesion)
    VALUES (BTRIM(_nombre), BTRIM(_apellidos), _idregion, _idcomuna, _idprofesion);

    RETURN QUERY SELECT TRUE::BOOLEAN, 'INSERTADO'::VARCHAR;
  ELSE
    IF NOT EXISTS (SELECT 1 FROM ejercicioajax.persona WHERE idpersona = _idpersona) THEN
      RETURN QUERY SELECT FALSE::BOOLEAN, 'IDPERSONA NO ENCONTRADO'::VARCHAR; RETURN;
    END IF;

    UPDATE ejercicioajax.persona
       SET nombre      = BTRIM(_nombre),
           apellidos   = BTRIM(_apellidos),
           idregion    = _idregion,
           idcomuna    = _idcomuna,
           idprofesion = _idprofesion
     WHERE idpersona   = _idpersona;

    RETURN QUERY SELECT TRUE::BOOLEAN, 'ACTUALIZADO'::VARCHAR;
  END IF;
END;
$$;
