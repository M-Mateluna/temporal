(function () {
  // Este JS corre dentro del iframe lb_bancos.php
  let BD;

  function alerta(m) {
    try { console.log(m); } catch (e) {}
    try { alert(m); } catch (e) {}
  }

  function cargarBancos() {
    BD = new BASE();
    // Forzamos a no cachear por si acaso
    BD.commandFile = 'command.php?ts=' + Date.now();

    let RS = BD.send('cmd=listar');

    // Validaciones defensivas
    if (!RS) {
      alerta('No llegó RS (resultado nulo) desde database/class.php.');
      return;
    }

    // Si RS.error trae algo (texto), lo mostramos
    if (RS.error && String(RS.error).trim() !== '') {
      alerta('Error DB:\n' + RS.error);
      return;
    }

    // numrows
    let n = parseInt(RS.numrows, 10) || 0;
    // console de apoyo
    try { console.log('Bancos recibidos:', n); } catch (e) {}

    let sel = document.getElementById('selBanco');
    if (!sel) {
      alerta('No se encontró el select con id="selBanco" en el iframe.');
      return;
    }

    // Limpia y agrega opción en blanco única
    sel.innerHTML = '';
    let opt0 = document.createElement('option');
    opt0.value = '';
    opt0.text = 'Seleccione...';
    sel.appendChild(opt0);

    // Poblar filas
    for (let i = 0; i < n; i++) {
      let id  = BD.getField(RS, 'idbanco', i);
      let nom = BD.getField(RS, 'nombre',  i) || '';

      // Si por alguna razón no hay nombre, saltamos
      if (nom === null || nom === undefined || String(nom).trim() === '') {
        continue;
      }

      let opt = document.createElement('option');
      opt.value = id;
      opt.text  = nom;
      sel.appendChild(opt);
    }

    // Si no llegó nada, lo indicamos (útil para descartar silencios)
    if (n === 0) {
      try { console.warn('Listado de bancos vacío (0 filas).'); } catch (e) {}
    }
  }

  function irAPagina() {
    let sel = document.getElementById('selBanco');
    let id  = sel.value;
    let nom = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';

    if (String(id).trim() === '') {
      // Mensaje en el padre
      try {
        top.MSGBOX.Abrir({
          titulocss: 'titulorojomsgbox',
          titulo: 'Advertencia',
          texto: 'Debe seleccionar un banco, para abrir el lightbox.',
          botonera: 1,
          fnretorno: 'top.retMsgOnlyClose',
          conCerrar: true
        });
      } catch (e) { alert('Debe seleccionar un banco.'); }
      return;
    }

    try { top.abrirLightboxBanco(nom); } catch (e) {
      alerta('No fue posible abrir el segundo lightbox.\n' + e.message);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    cargarBancos();
    let btn = document.getElementById('btnGo');
    if (btn) btn.onclick = irAPagina;
  });
})();
