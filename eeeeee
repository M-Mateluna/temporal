/* =======================
   utils.js  (validaciones + hook)
   ES5 compatible
   ======================= */

/* --- Normaliza y valida RUT chileno --- */
function validaRUT(rut) {
  if (!rut) return false;

  var limpio = (rut + '').replace(/\./g, '').replace(/\s+/g, '').toUpperCase();

  // Si viene sin guion, asumimos último carácter como DV
  if (limpio.indexOf('-') === -1 && limpio.length > 1) {
    limpio = limpio.slice(0, -1) + '-' + limpio.slice(-1);
  }

  var partes = limpio.split('-');
  if (partes.length !== 2) return false;

  var cuerpo = partes[0];
  var dv = partes[1];

  if (!/^\d+$/.test(cuerpo)) return false;     // solo números en el cuerpo
  if (!/^[0-9K]$/.test(dv)) return false;      // DV numérico o K

  // Cálculo DV (módulo 11)
  var suma = 0, multiplo = 2;
  for (var i = cuerpo.length - 1; i >= 0; i--) {
    suma += parseInt(cuerpo.charAt(i), 10) * multiplo;
    multiplo = (multiplo === 7) ? 2 : multiplo + 1;
  }

  var resto = suma % 11;
  var dvCalcNum = 11 - resto;
  var dvCalc = (dvCalcNum === 11) ? '0' : (dvCalcNum === 10 ? 'K' : String(dvCalcNum));

  return dv === dvCalc;
}

/* --- Valida email simple y robusto --- */
function validaEmail(email) {
  if (!email) return false;
  var e = ('' + email).replace(/^\s+|\s+$/g, '');
  var re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
  return re.test(e);
}

/* --- Helpers para leer valores/checkbox --- */
function getVal(id) {
  var el = document.getElementById(id);
  return el ? (('value' in el) ? ('' + el.value).replace(/^\s+|\s+$/g, '') : '') : '';
}
function isChecked(id) {
  var el = document.getElementById(id);
  return !!(el && el.checked);
}
function getOrigenes() {
  var arr = [];
  if (isChecked('web')) arr.push('web');
  if (isChecked('tv')) arr.push('tv');
  if (isChecked('amigos')) arr.push('amigos');
  return arr;
}

/* --- Validación general del formulario ---
   Retorna true si todo OK; si no, muestra alert y retorna false. */
function validarFormulario() {
  var nombre        = getVal('nombre');
  var apellidos     = getVal('apellidos');
  var rut           = getVal('rut');
  var email         = getVal('email');
  var fecha         = getVal('fecha');
  var horario       = getVal('horario');
  var region        = getVal('region');
  var comuna        = getVal('comuna');
  var nombremascota = getVal('nombremascota');

  function obligatorio(val, nombreCampo) {
    if (!val) { alert('El campo ' + nombreCampo + ' es obligatorio'); return false; }
    return true;
  }

  if (!obligatorio(nombre, 'Nombre')) return false;
  if (!obligatorio(apellidos, 'Apellidos')) return false;

  if (!obligatorio(rut, 'RUT')) return false;
  if (!validaRUT(rut)) { alert('El campo RUT no tiene un formato correcto'); return false; }

  if (!obligatorio(email, 'Email')) return false;
  if (!validaEmail(email)) { alert('El campo Email no tiene un formato correcto'); return false; }

  if (!obligatorio(fecha, 'Fecha de Consulta')) return false;
  if (!obligatorio(horario, 'Horario')) return false;
  if (!obligatorio(region, 'Region')) return false;
  if (!obligatorio(comuna, 'Comuna')) return false;
  if (!obligatorio(nombremascota, 'Nombre Mascota')) return false;

  // Al menos 2 checkboxes: web, tv, amigos
  var origenes = getOrigenes();
  if (origenes.length < 2) {
    alert('Debe seleccionar a lo menos 2 formas de como se enteró de nosotros');
    return false;
  }

  return true; // listo para continuar
}

/* --- Reservar (stub) ---
   Ahora recibe un objeto con todos los datos, incluido 'recordatorio' y 'origenes'. */
function reservar(data) {
  // TODO: implementar envío/inserción en la próxima actividad con 'data'
  // data.recordatorio es boolean; data.origenes es array ['web','tv',...]
}

/* --- Hook: evitar navegación y usar las validaciones --- */
function handleSubmit(e) {
  if (e && e.preventDefault) e.preventDefault(); // nunca navegar

  if (!validarFormulario()) return false;

  // Construimos el payload (incluye recordatorio y origenes)
  var payload = {
    nombre:        getVal('nombre'),
    apellidos:     getVal('apellidos'),
    rut:           getVal('rut'),
    email:         getVal('email'),
    fecha:         getVal('fecha'),
    horario:       getVal('horario'),
    region:        getVal('region'),
    comuna:        getVal('comuna'),
    nombremascota: getVal('nombremascota'),
    recordatorio:  isChecked('recordatorio'),
    origenes:      getOrigenes()
  };

  var msgRec = payload.recordatorio ? 'Sí' : 'No';
  alert('Validación exitosa. Recordatorio: ' + msgRec + '. (Aquí se llamará a reservar())');

  reservar(payload);
  return false; // mantener en página
}

/* Enganche al cargar el DOM (sin otros archivos JS) */
document.addEventListener('DOMContentLoaded', function () {
  var form = document.getElementById('form-reserva');
  if (form) {
    form.addEventListener('submit', handleSubmit);
  }
  // Por si tu botón “Reservar” es type="button"
  var btn = document.querySelector('.btn-reservar');
  if (btn) {
    btn.addEventListener('click', handleSubmit);
  }
});
