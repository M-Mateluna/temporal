// controlador.js — Ejercicio 2: Dependencia entre Selects (Desis)

let BD = new BASE();
BD.commandFile = 'command.php'; // misma carpeta que index.php

let selRegion = document.getElementById('selRegion');
let selComuna = document.getElementById('selComuna');

// Limpia el select y agrega opción vacía
let clearAndAddEmpty = function(selectEl) {
  selectEl.innerHTML = '';
  let opt = document.createElement('option');
  opt.value = '';
  opt.textContent = ''; // opción por defecto vacía
  selectEl.appendChild(opt);
};

// Cargar regiones
let cargarRegiones = function() {
  clearAndAddEmpty(selRegion);
  clearAndAddEmpty(selComuna);

  let RS = BD.send('cmd=regiones');
  if (RS.error && RS.error.trim() !== '') {
    alert('Error: ' + RS.error);
    return;
  }

  for (let i = 0; i < Number(RS.numrows || 0); i++) {
    let idregion = BD.getField(RS, 'idregion', i);
    let nombre   = BD.getField(RS, 'nombre', i);

    let opt = document.createElement('option');
    opt.value = idregion;
    opt.textContent = nombre;
    selRegion.appendChild(opt);
  }
};

// Cargar comunas según la región seleccionada
let cargarComunas = function(idregion) {
  clearAndAddEmpty(selComuna);
  if (!idregion) return;

  let RS = BD.send('cmd=comunas&idregion=' + encodeURIComponent(idregion));
  if (RS.error && RS.error.trim() !== '') {
    alert('Error: ' + RS.error);
    return;
  }

  for (let i = 0; i < Number(RS.numrows || 0); i++) {
    let idcomuna = BD.getField(RS, 'idcomuna', i);
    let nombre   = BD.getField(RS, 'nombre', i);

    let opt = document.createElement('option');
    opt.value = idcomuna;
    opt.textContent = nombre;
    selComuna.appendChild(opt);
  }
};

// Evento: al cambiar la región
selRegion.addEventListener('change', function() {
  cargarComunas(selRegion.value);
});

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
  cargarRegiones();
});
