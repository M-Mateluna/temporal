(function () {
  // Corre dentro del iframe
  let BD = new BASE();
  BD.commandFile = 'command.php'; // no rutas, est치ndar Desis

  // Mapa simple de URLs (si un banco no est치, se abre una b칰squeda)
  const BANK_URLS = {
    'BANCO DE CHILE': 'https://www.bancochile.cl',
    'BANCOESTADO':   'https://www.bancoestado.cl',
    'BANCO ESTADO':  'https://www.bancoestado.cl',
    'BANCO SANTANDER': 'https://www.santander.cl',
    'BCI':           'https://www.bci.cl',
    'SCOTIABANK':    'https://www.scotiabankchile.cl',
    'ITAU':          'https://www.itau.cl',
    'BANCO ITAU':    'https://www.itau.cl',
    'CORPBANCA':     'https://www.itaubank.cl', // ejemplo hist칩rico
  };

  function urlBanco(nombre) {
    const k = String(nombre || '').replace(/\s+/g,' ').trim().toUpperCase();
    if (BANK_URLS[k]) return BANK_URLS[k];
    // fallback a b칰squeda
    return 'https://www.google.com/search?q=' + encodeURIComponent(nombre + ' sitio oficial');
  }

  function cargarBancos() {
    const RS = BD.send('cmd=listar');
    if (!RS) { alert('No lleg칩 RS desde database/class.php'); return; }
    if (RS.error && String(RS.error).trim() !== '') { alert('Error DB:\n' + RS.error); return; }

    const n = parseInt(RS.numrows, 10) || 0;
    const sel = document.getElementById('selBanco');
    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.text  = 'Seleccione...';
    sel.appendChild(opt0);

    for (let i = 0; i < n; i++) {
      const id  = BD.getField(RS, 'idbanco', i);
      const nom = BD.getField(RS, 'nombre',  i) || '';
      if (!nom) continue;
      const opt = document.createElement('option');
      opt.value = id;
      opt.text  = nom;
      sel.appendChild(opt);
    }
  }

  // Abre segundo lightbox DENTRO del iframe (como en la maqueta)
  function abrirLBWebBanco(nombre) {
    const IUlb = new IU();
    IUlb.ShowInfoWidget(urlBanco(nombre), 420, 700, 'CerrarLBInterno', 80);
    // expone cierre para el link [X] del componente
    window.CerrarLBInterno = function(){ IUlb.HideInfo(); };
  }

  function irAPagina() {
    const sel = document.getElementById('selBanco');
    const id  = sel.value;
    const nom = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';

    if (String(id).trim() === '') {
      // Mostrar MSGBOX en el padre y por encima del overlay
      try {
        top.MSGBOX.Abrir({
          titulocss: 'titulorojomsgbox',
          titulo: 'Advertencia',
          texto: 'Debe seleccionar un banco, para abrir el lightbox.',
          botonera: 1,
          fnretorno: 'top.retMsgOnlyClose',
          conCerrar: true,
          zzIndex: 9000 // 游녣 asegura que quede sobre el overlay
        });
      } catch (e) { alert('Debe seleccionar un banco.'); }
      return;
    }

    abrirLBWebBanco(nom);
  }

  document.addEventListener('DOMContentLoaded', function () {
    cargarBancos();
    const btn = document.getElementById('btnGo');
    if (btn) btn.onclick = irAPagina;
  });
})();
