/* controlador.js â€” Ejercicio Propuesto: ClienteProveedor2 (Desis) */
let clienteproveedor;
let _ultimoMetodo = ""; // 'keypress' o 'click'

window.onload = function() {
  // === Precargar fecha/hora ===
  let fh = document.getElementById('fechahora');
  if (fh && !fh.value) {
    let d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    fh.value = d.toISOString().slice(0,16);
  }

  // === Configurar componente ClienteProveedor2 ===
  clienteproveedor = new ClienteProveedor2();

  clienteproveedor.ubicacion = document.getElementById("divBuscador");
  clienteproveedor.elementoBuscador = "rut";
  clienteproveedor.elementos = {
    rut: document.getElementById("rut"),
    idclienteproveedor: document.getElementById("cliente2"),
    giro: document.getElementById("giro"),
    idusuario: document.getElementById("idusuario"),
    fechahora: document.getElementById("fechahora")
  };

  clienteproveedor.creaBotonBuscar = true;
  clienteproveedor.creaBotonBorrar = true;
  clienteproveedor.creaBotonCrear  = true;
  clienteproveedor.tituloGrilla = "Clientes vigentes facturando";
  clienteproveedor.filtro = "cliente|vigente"; // opcional: |factura
  clienteproveedor.islightbox = true;
  clienteproveedor.altoLightbox = 500;
  clienteproveedor.anchoLightbox = 800;

  // === Eventos ===
  document.getElementById('rut').addEventListener('keypress', function () {
    _ultimoMetodo = "keypress";
  });

  clienteproveedor.afterEvent = function () {
    // Autocompletar fecha si no existe
    let fh = document.getElementById('fechahora');
    if (fh && !fh.value) {
      let d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      fh.value = d.toISOString().slice(0,16);
    }

    if (_ultimoMetodo === "keypress") {
      document.getElementById('idusuario').disabled = true;
      document.getElementById('giro').disabled = true;

      MSGBOX.Abrir({
        titulo: 'AfterEvent',
        texto: 'Se ha desencadenado el evento <b>Onkeypress</b>, bloqueando <b>idusuario</b> y <b>giro</b>.',
        botonera: 1
      });
    } else {
      document.getElementById('rut').disabled = true;
      document.getElementById('giro').disabled = true;
      document.getElementById('idusuario').disabled = true;

      MSGBOX.Abrir({
        titulo: 'AfterEvent',
        texto: 'Se ha desencadenado el evento <b>Onclick</b>, bloqueando <b>rut</b>, <b>giro</b> y <b>idusuario</b>.',
        botonera: 1
      });
    }

    _ultimoMetodo = ""; // reset
  };

  // Inicializar componente
  clienteproveedor.New();
};
