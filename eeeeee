CREATE OR REPLACE FUNCTION public.fn_persona_iu(
  _idpersona   INT,
  _nombre      TEXT,
  _apellidos   TEXT,
  _idregion    INT,
  _idcomuna    INT,
  _idprofesion INT
)
RETURNS TABLE(success BOOLEAN, message TEXT, idpersona INT)
LANGUAGE plpgsql
AS $$
BEGIN
  -- VALIDACIONES BÁSICAS
  IF _nombre IS NULL OR BTRIM(_nombre) = '' THEN
    RETURN QUERY SELECT FALSE, 'EL NOMBRE ES OBLIGATORIO', 0;
    RETURN;
  END IF;

  IF _apellidos IS NULL OR BTRIM(_apellidos) = '' THEN
    RETURN QUERY SELECT FALSE, 'LOS APELLIDOS SON OBLIGATORIOS', 0;
    RETURN;
  END IF;

  -- EXISTENCIA PROFESIÓN
  IF NOT EXISTS (SELECT 1 FROM public.profesion WHERE idprofesion = _idprofesion) THEN
    RETURN QUERY SELECT FALSE, 'IDPROFESION INEXISTENTE', 0;
    RETURN;
  END IF;

  -- COMUNA PERTENECE A REGIÓN
  IF NOT EXISTS (SELECT 1 FROM public.comuna WHERE idcomuna = _idcomuna AND idregion = _idregion) THEN
    RETURN QUERY SELECT FALSE, 'LA COMUNA NO PERTENECE A LA REGION', 0;
    RETURN;
  END IF;

  -- UNICIDAD NOMBRE+APELLIDOS (excluye al propio si es UPDATE)
  IF EXISTS (
    SELECT 1
      FROM public.persona
     WHERE LOWER(BTRIM(nombre))    = LOWER(BTRIM(_nombre))
       AND LOWER(BTRIM(apellidos)) = LOWER(BTRIM(_apellidos))
       AND (_idpersona = 0 OR idpersona <> _idpersona)
  ) THEN
    RETURN QUERY SELECT FALSE, 'YA EXISTE UNA PERSONA CON EL MISMO NOMBRE Y APELLIDOS', 0;
    RETURN;
  END IF;

  -- INSERT / UPDATE
  IF _idpersona = 0 THEN
    RETURN QUERY
    WITH ins AS (
      INSERT INTO public.persona (nombre, apellidos, idregion, idcomuna, idprofesion, fechahora)
      VALUES (BTRIM(_nombre), BTRIM(_apellidos), _idregion, _idcomuna, _idprofesion, NOW())
      RETURNING idpersona
    )
    SELECT TRUE, 'INSERTADO', idpersona FROM ins;
  ELSE
    -- Verifica existencia antes del UPDATE (sin variables)
    IF NOT EXISTS (SELECT 1 FROM public.persona WHERE idpersona = _idpersona) THEN
      RETURN QUERY SELECT FALSE, 'IDPERSONA NO ENCONTRADO', 0;
      RETURN;
    END IF;

    RETURN QUERY
    WITH upd AS (
      UPDATE public.persona
         SET nombre      = BTRIM(_nombre),
             apellidos   = BTRIM(_apellidos),
             idregion    = _idregion,
             idcomuna    = _idcomuna,
             idprofesion = _idprofesion,
             fechahora   = NOW()
       WHERE idpersona   = _idpersona
       RETURNING idpersona
    )
    SELECT TRUE, 'ACTUALIZADO', idpersona FROM upd;
  END IF;
END;
$$;
