<?php
// Resolver POSICION robusto (evita HTTP 500 si no encuentra rutas)
$POSICION = isset($POSICION) ? $POSICION : '';
for ($i=0; $i<12 && !file_exists($POSICION."conexion.php"); $i++) { $POSICION .= "../"; }
if (!file_exists($POSICION."conexion.php")) {
  header('Content-Type: text/plain; charset=ISO-8859-1');
  die("No se encontró conexion.php desde lb_fecha.php. POSICION: ".$POSICION);
}
require_once($POSICION."formHeader.php");

// Hoy y rango permitido (±1 mes)
$hoy = new DateTime('today');
$min = (clone $hoy)->modify('-1 month')->format('Y-m-d');
$max = (clone $hoy)->modify('+1 month')->format('Y-m-d');
$hoyStr = $hoy->format('Y-m-d');
?>
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Termino Contrato</title>

  <link rel="stylesheet" href="<?=$POSICION?>css/nuevoestilo.css?v=1.8">
  <style>
    .wrap{ min-width:560px; padding:18px 20px; background:#f1f1f1; }
    .fila{ display:flex; align-items:center; gap:8px; margin:12px 0 16px; }
    .btn{ height:30px; padding:0 12px; border:1px solid #6c757d; background:#e9ecef; border-radius:6px; cursor:pointer; }
    .input-clear-wrap{ position:relative; width:260px; }
    .input-clear-wrap input{ width:100%; height:26px; padding-right:28px; }
    .clear-btn{
      position:absolute; right:5px; top:50%; transform:translateY(-50%);
      width:18px; height:18px; line-height:16px; text-align:center;
      border:1px solid #aaa; border-radius:3px; background:#fff; cursor:pointer; font-weight:bold;
    }
    .titulo{ font-weight:bold; margin-bottom:8px; }
  </style>
</head>
<body>
<div class="FORMULARIONECSS wrap">
  <div class="titulo">Termino Contrato</div>

  <div class="fila">
    <label for="fechaTermino" style="min-width:220px">Ingrese Fecha de Término:</label>

    <!-- Campo 'calendario' no editable con botón borrar tipo icono -->
    <div class="input-clear-wrap">
      <input type="date" id="fechaTermino" value="<?=$hoyStr?>" min="<?=$min?>" max="<?=$max?>" readonly onfocus="this.blur();">
      <button type="button" id="btnClear" class="clear-btn" title="Borrar">×</button>
    </div>
  </div>

  <div class="fila">
    <button type="button" id="btnGuardar" class="btn">Guardar</button>
  </div>
</div>

<!-- MessageBox oficial -->
<script src="<?=$POSICION?>componente/messagebox/class.php?v=1"></script>
<script>
// ===== MSGBOX wrapper (solo Aceptar) =====
var MSGBOX = {
  ventana: undefined,
  init: function(){ try{ this.ventana = new IU_MSGBOX(); }catch(e){} },
  abrir: function(titulo, texto){
    if (!this.ventana){ alert(titulo + "\\n\\n" + texto); return; }
    this.ventana.titulo   = titulo;
    this.ventana.texto    = '<center>'+ texto +'</center>';
    this.ventana.botonera = 1; // Aceptar
    this.ventana.conCerrar= false;
    this.ventana.Messagebox();
  },
  cerrar: function(){ try{ this.ventana && this.ventana.HideInfo(); }catch(e){} }
}; MSGBOX.init();

// YYYY-MM-DD -> DD-MM-YYYY
function toDMY(s){ var m=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); return m? (m[3]+'-'+m[2]+'-'+m[1]) : ''; }

// Cerrar lightbox con la API de la wiki
function cerrarLightbox(){
  try {
    if (window.parent && typeof window.parent.OcultarVentana === 'function') {
      window.parent.OcultarVentana(); return;
    }
  } catch(e){}
  try { window.close(); } catch(e){}
}

// Botón borrar icono
document.getElementById('btnClear').onclick = function(){
  var f = document.getElementById('fechaTermino');
  if (f) f.value = '';
};

// Guardar: valida y devuelve al padre
document.getElementById('btnGuardar').onclick = function(){
  var f = document.getElementById('fechaTermino');
  var val = f ? f.value : '';

  if (!val) {
    MSGBOX.abrir('Obligatorio', 'El campo fecha es obligatorio');
    return;
  }

  var dmy = toDMY(val);
  try {
    if (window.parent) {
      window.parent.postMessage({ type:'set_fecha', value:dmy }, '*');
    }
  } catch(e){}
  cerrarLightbox();
};
</script>
</body>
</html>
