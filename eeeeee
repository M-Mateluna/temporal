// ---------- Carga bancos (DB via BASE) ----------
const BD = new BASE();
BD.commandFile = 'form/training/Lightbox/Ejercicio1/command.php';

const sel = document.getElementById('selBanco');
const btnIr = document.getElementById('btnIr');

// Inicializa select con opción vacía
function resetSelect() {
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.text = 'Seleccione...';
  sel.appendChild(opt0);
}

function cargarBancos() {
  resetSelect();

  const RS = BD.send('cmd=listar');
  if (RS.error && String(RS.error).trim() !== '') {
    alert('Error DB:\n' + RS.error);
    return;
  }
  const n = Number(RS.numrows || 0);
  for (let i = 0; i < n; i++) {
    let id  = BD.getField(RS, 'idbanco', i) || '';
    let nom = BD.getField(RS, 'nombre', i) || '';
    if (!id || !nom) continue;

    const op = document.createElement('option');
    op.value = nom;   // Usaremos el nombre en el detalle (tal como pediste)
    op.text  = nom;
    sel.appendChild(op);
  }
}

// ---------- MSGBOX wrapper (Advertencia) ----------
var MSGBOX = {
  ventana: null,
  init: function() {
    this.ventana = new IU_MSGBOX();
  },
  abrir: function(conf) {
    this.ventana.titulo   = conf.titulo || 'Aviso';
    this.ventana.texto    = '<center>' + (conf.texto || '') + '</center>';
    this.ventana.botonera = conf.botonera || 1;   // 1 = Aceptar
    this.ventana.conCerrar = (conf.conCerrar === false) ? false : true;
    this.ventana.fnretorno = conf.fnretorno || 'MSGBOXaccion';
    this.ventana.url = posicion;
    this.ventana.top = conf.top || '25%';
    this.ventana.objeto = conf.objeto || {};
    this.ventana.Messagebox();
    this.ventana.zzIndex = 2;  // sobre lo que haya
  }
};
MSGBOX.init();

function advertenciaSeleccion() {
  MSGBOX.abrir({
    titulo: 'Advertencia',
    texto: 'Debe seleccionar un banco, para abrir el lightbox.',
    botonera: 1,              // Aceptar
    conCerrar: true,
    titulocss: 'titulorojomsgbox'
  });
}

// ---------- Abrir segundo lightbox ENCIMA ----------
function abrirLBSegundo(nombreBanco) {
  const url = posicion + 'form/training/Lightbox/Ejercicio1/lb_banco_detalle.php?nombre=' + encodeURIComponent(nombreBanco);

  // Abrir sobre el overlay actual
  if (window.parent && window.parent.Ajuste && window.parent.Ajuste.ventana &&
      typeof window.parent.Ajuste.ventana.ShowInfoDentro === 'function') {
    window.parent.Ajuste.ventana.ShowInfoDentro(url, 380, 820);
  } else if (window.parent && typeof window.parent.OpenLightbox === 'function') {
    // Fallback (no apila, pero no rompe)
    window.parent.OpenLightbox(820, 380, url);
  }
}

// ---------- Eventos ----------
btnIr.addEventListener('click', function () {
  const nom = sel.value || '';
  if (!nom) { advertenciaSeleccion(); return; }
  abrirLBSegundo(nom);
});

// Carga inicial
cargarBancos();
