DROP VIEW IF EXISTS trainingmmateluna.vw_porcentaje_reservas;

CREATE OR REPLACE VIEW trainingmmateluna.vw_porcentaje_reservas AS
WITH tot AS (
  SELECT CAST(COUNT(*) AS NUMERIC) AS n
  FROM trainingmmateluna.reserva
)
SELECT
  h.descripcion AS horario,
  CAST(COUNT(r.idreserva) AS INT) AS cantidad,
  CASE
    WHEN (SELECT n FROM tot) > 0 THEN
      -- trunca a entero (si prefieres redondear, ver variante abajo)
      CAST( (CAST(COUNT(r.idreserva) AS NUMERIC) * 100.0) / (SELECT n FROM tot) AS INT )
    ELSE 0
  END AS porcentaje
FROM trainingmmateluna.horario h
LEFT JOIN trainingmmateluna.reserva r
  ON r.idhorario = h.idhorario
GROUP BY h.descripcion
ORDER BY cantidad DESC, horario ASC;
