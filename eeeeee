<?php
// --- Resolver POSICION de forma robusta ---
$POSICION = isset($POSICION) ? $POSICION : '';
for ($i = 0; $i < 12; $i++) {               // sube hasta 12 niveles
    if (file_exists($POSICION."conexion.php")) break;
    $POSICION .= "../";
}
if (!file_exists($POSICION."conexion.php")) {
    // Evita un 500: muestra un mensaje de diagnóstico (temporal)
    header('Content-Type: text/plain; charset=ISO-8859-1');
    die("No se encontró conexion.php desde lb_fecha.php. POSICION actual: ".$POSICION);
}

require($POSICION."formHeader.php");

// Cálculo de hoy y rango +/- 1 mes
$hoy = new DateTime('today');
$min = (clone $hoy)->modify('-1 month')->format('Y-m-d');
$max = (clone $hoy)->modify('+1 month')->format('Y-m-d');
$hoyStr = $hoy->format('Y-m-d');
?>
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Termino Contrato</title>
  <link rel="stylesheet" href="<?=$POSICION?>css/nuevoestilo.css?v=1.8">
  <style>
    .wrap { min-width:560px; padding:18px 20px; background:#f1f1f1; }
    .fila { display:flex; align-items:center; gap:10px; margin:10px 0 16px; }
    .btn  { height:32px; padding:0 12px; border:1px solid #6c757d; background:#e9ecef; border-radius:6px; cursor:pointer; }
    #fechaTermino { height:26px; }
    .titulo { font-weight:bold; margin-bottom:8px; }
  </style>
</head>
<body>
<div class="wrap FORMULARIONECSS">
  <div class="titulo">Termino Contrato</div>

  <div class="fila">
    <label for="fechaTermino" style="min-width:220px">Ingrese Fecha de Término:</label>
    <input type="date" id="fechaTermino" value="<?=$hoyStr?>" min="<?=$min?>" max="<?=$max?>" readonly onfocus="this.blur();">
    <button type="button" id="btnBorrar" class="btn" title="Borrar fecha">✖</button>
  </div>

  <div class="fila">
    <button type="button" id="btnGuardar" class="btn">Guardar</button>
  </div>
</div>

<script src="<?=$POSICION?>componente/messagebox/class.php?v=1"></script>
<script>
// --- Messagebox wrapper ---
var MSGBOX = { ventana:undefined,
  init:function(){ try{ this.ventana=new IU_MSGBOX(); }catch(e){} },
  show:function(t,t2){ if(!this.ventana){ alert(t+"\\n\\n"+t2); return; }
    this.ventana.titulo=t; this.ventana.texto='<center>'+t2+'</center>'; this.ventana.botonera=1; this.ventana.Messagebox(); },
  close:function(){ try{ this.ventana && this.ventana.HideInfo(); }catch(e){} }
}; MSGBOX.init();

function toDMY(s){ var m=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); return m? (m[3]+'-'+m[2]+'-'+m[1]) : ''; }

function cerrarLightbox(){
  try {
    if (window.parent && typeof window.parent.OcultarVentana==='function'){ window.parent.OcultarVentana(); return; }
    if (typeof OcultarVentana==='function'){ OcultarVentana(); return; }
  } catch(e){}
  try { window.close(); } catch(e){}
}

document.getElementById('btnBorrar').onclick = function(){
  var f=document.getElementById('fechaTermino'); if(f) f.value='';
};

document.getElementById('btnGuardar').onclick = function(){
  var f=document.getElementById('fechaTermino'); var v=f?f.value:'';
  if(!v){ MSGBOX.show('Obligatorio','El campo fecha es obligatorio'); return; }
  var dmy=toDMY(v);
  try {
    if (window.parent && window.parent!==window) { window.parent.postMessage({type:'set_fecha',value:dmy}, '*'); }
    else if (window.opener) { window.opener.postMessage({type:'set_fecha',value:dmy}, '*'); }
  } catch(e){}
  cerrarLightbox();
};
</script>
</body>
</html>
