// controlador.js — Dependencia entre selects con BASE (class.php)

(function () {

  // Ajusta la ruta si tu carpeta tiene espacios o está en otra ubicación.
  // Si está en la MISMA carpeta que index.php, así está bien:
  const BD = new BASE();
  BD.commandFile = 'command.php';

  const selRegion = document.getElementById('selRegion');
  const selComuna = document.getElementById('selComuna');

  // Helpers
  function clearAndAddEmpty(selectEl) {
    selectEl.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '';              // opción vacía (por defecto)
    selectEl.appendChild(opt);
  }

  function loadRegiones() {
    clearAndAddEmpty(selRegion);
    clearAndAddEmpty(selComuna);

    const RS = BD.send('cmd=regiones');
    if (RS.error && RS.error.trim() !== '') {
      alert('Error: ' + RS.error);
      return;
    }

    for (let i = 0; i < Number(RS.numrows || 0); i++) {
      let id    = BD.getField(RS, 'idregion', i);
      let nombre = BD.getField(RS, 'nombre', i);

      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = nombre;
      selRegion.appendChild(opt);
    }
  }

  function loadComunasByRegion(idregion) {
    clearAndAddEmpty(selComuna);
    if (!idregion) return;

    const RS = BD.send('cmd=comunas&idregion=' + encodeURIComponent(idregion));
    if (RS.error && RS.error.trim() !== '') {
      alert('Error: ' + RS.error);
      return;
    }

    for (let i = 0; i < Number(RS.numrows || 0); i++) {
      let id    = BD.getField(RS, 'idcomuna', i);
      let nombre = BD.getField(RS, 'nombre', i);

      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = nombre;
      selComuna.appendChild(opt);
    }
  }

  // Eventos
  selRegion.addEventListener('change', () => {
    loadComunasByRegion(selRegion.value);
  });

  // Init
  if (document.readyState !== 'loading') loadRegiones();
  else document.addEventListener('DOMContentLoaded', loadRegiones);
})();
