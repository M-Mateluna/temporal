<?php
// Resuelve la raíz del proyecto para rutas robustas
$POSICION = "";
while (!file_exists($POSICION."conexion.php")) { $POSICION .= "../"; }
?>
<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Gestión de Clientes / Proveedores</title>

  <link type="text/css" rel="stylesheet" href="<?=$POSICION?>css/nuevoestilo.css?v=1.8">

  <style type="text/css">
    .contenedor { max-width: 600px; margin: auto; text-align: -webkit-center; background: #f1f1f1; }
    .contenedor label { display: block; text-align: left; margin-bottom: 6px; }
    .contenedor td { padding: 6px 15px; margin-bottom: 6px; }
    .buscador-inline { display: inline-flex; align-items: center; gap: 6px; }
  </style>
</head>

<body>
  <div class="FORMULARIONECSS contenedor">
    <form id="frmCP" method="post" autocomplete="off" onsubmit="return false;">
      <fieldset>
        <legend class="legends">Información del Registro</legend>

        <table class="grid" cellspacing="0" cellpadding="0">
          <tr class="fila">
            <td>
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td class="stack">
                    <label for="rut">RUT</label>
                    <div class="buscador-inline">
                      <input type="text" name="rut" id="rut" maxlength="20" placeholder="12.345.678-9">
                      <span id="divBuscador"></span><!-- lupa/crear/borrar -->
                    </div>
                    <input type="hidden" name="cliente2" id="cliente2">
                  </td>
                </tr>
              </table>
            </td>

            <td>
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td class="stack">
                    <label for="giro">Giro</label>
                    <input type="text" name="giro" id="giro" maxlength="120">
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <tr class="fila">
            <td>
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td class="stack">
                    <label for="idusuario">ID Usuario</label>
                    <input type="text" name="idusuario" id="idusuario" maxlength="10">
                  </td>
                </tr>
              </table>
            </td>

            <td>
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td class="stack">
                    <label for="fechahora">Fecha/Hora</label>
                    <input type="datetime-local" name="fechahora" id="fechahora">
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </fieldset>
    </form>
  </div>

  <!-- Dependencias con $POSICION -->
  <script type="text/javascript" src="<?=$POSICION?>componente/database/class.php"></script>
  <script type="text/javascript" src="<?=$POSICION?>js/util.js"></script>

  <!-- Polyfill simple para MessageBox antiguos (evita 'Class is not defined') -->
  <script>
    if (typeof Class === "undefined") {
      var Class = { create: function(){ return function(){ this.initialize && this.initialize.apply(this, arguments); }; } };
    }
  </script>

  <script type="text/javascript" src="<?=$POSICION?>componente/messagebox/class.php?v=1"></script>
  <script type="text/javascript" src="<?=$POSICION?>componente/buscadores/clienteproveedor2/class.js"></script>

  <script type="text/javascript">
    // Utilidades fecha para <input type="datetime-local">
    function pad(n){ return (n<10?'0'+n:n); }
    function formatoFechaLocal(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); }
    function toDatetimeLocal(val){
      if (!val) return '';
      var s = String(val).trim()
        .replace(/Z$/,'').replace(/[+-]\d{2}:?\d{2}$/,'')
        .replace(' ','T').replace(/\.\d+$/,'');
      var m = s.match(/^(\d{4}-\d{2}-\d{2})[T ](\d{2}):(\d{2})(?::\d{2})?$/);
      if (m) return m[1]+'T'+m[2]+':'+m[3];
      var d = new Date(val); return isNaN(d)?'':formatoFechaLocal(d);
    }

    // Set inicial de Fecha/Hora si viene vacío
    (function(){
      var fh = document.getElementById('fechahora');
      if (fh && !fh.value) fh.value = formatoFechaLocal(new Date());
    })();

    // === ClienteProveedor2 (modo ventana, visual intacto) ===
    (function(){
      var cp = new ClienteProveedor2();

      cp.ubicacion = document.getElementById('divBuscador');
      cp.elementoBuscador = 'rut';

      cp.elementos = {
        rut: document.getElementById('rut'),
        idclienteproveedor: document.getElementById('cliente2'),
        giro: document.getElementById('giro'),
        idusuario: document.getElementById('idusuario'),
        fechahora: document.getElementById('fechahora')
      };

      cp.creaBotonBuscar = true;
      cp.creaBotonBorrar = true;
      cp.creaBotonCrear  = true;

      cp.filtro = 'cliente|vigente|puedefacturar';
      cp.tituloGrilla = 'Clientes vigentes facturando';

      cp.islightbox = false;   // ventana para no alterar la UI base
      cp.alto = 500; cp.ancho = 800;

      cp.afterEvent = function(self){
        // Normaliza fecha/hora si viene con espacios y microsegundos
        if (self.elementos.fechahora) {
          var norm = toDatetimeLocal(self.elementos.fechahora.value);
          if (norm) self.elementos.fechahora.value = norm;
          if (!self.elementos.fechahora.value) self.elementos.fechahora.value = formatoFechaLocal(new Date());
        }

        if (self.ultimoEvento === 'onkeypress') {
          self.elementos.idusuario.disabled = true;
          self.elementos.giro.disabled = true;
          MSGBOX.Abrir({
            titulo: 'AfterEvent',
            texto: 'Se ha desencadenado el evento <b>Onkeypress</b>, bloqueando <b>idusuario</b> y <b>giro</b>.',
            botonera: 1
          });
        } else { // onclick
          self.elementos.rut.disabled = true;
          self.elementos.giro.disabled = true;
          self.elementos.idusuario.disabled = true;
          MSGBOX.Abrir({
            titulo: 'AfterEvent',
            texto: 'Se ha desencadenado el evento <b>Onclick</b>, bloqueando <b>rut</b>, <b>giro</b> y <b>idusuario</b>.',
            botonera: 1
          });
        }
      };

      cp.New();
    })();
  </script>
</body>
</html>
